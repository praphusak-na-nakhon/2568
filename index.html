<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบส่งงานนักเรียน</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; }
        .container { max-width: 500px; }
        .card { border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-primary { background-color: #06C755; border-color: #06C755; }
        .btn-primary:hover { background-color: #05a647; border-color: #05a647; }
        #loading, #successMessage { display: none; }

        /* --- CSS ที่แก้ไข --- */
        /* สไตล์สำหรับ Label ที่ทำให้ดูเหมือนปุ่มอัปโหลด */
        .btn-file-upload {
            background-color: #00B900;
            border-color: #00B900;
            color: white;
            font-size: 1.1rem;
            padding: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            border-radius: .5rem; /* ทำให้ขอบมนเหมือนปุ่ม */
        }
        .btn-file-upload:hover {
            background-color: #00a000;
            border-color: #00a000;
        }
        /* ซ่อน input[type=file] ของจริง แต่ยังคงให้ทำงานได้ */
        #imageFile {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="card">
            <div class="card-body">
                <h3 class="card-title text-center mb-4">ส่งงานนักเรียน</h3>
                
                <form id="submissionForm">
                    <div class="mb-3">
                        <label for="studentId" class="form-label"><strong>รหัสนักเรียน</strong></label>
                        <input type="number" class="form-control" id="studentId" required>
                    </div>
                    <div class="mb-3">
                        <label for="assignment" class="form-label"><strong>เลือกชิ้นงาน</strong></label>
                        <select class="form-select" id="assignment" required>
                            <option value="">-- กรุณาเลือก --</option>
                            <option value="1">งานครั้งที่ 1</option>
                            <option value="2">งานครั้งที่ 2</option>
                            <option value="3">งานครั้งที่ 3</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>แนบรูปภาพงาน</strong></label>
                        <div class="d-grid gap-2">
                            <label for="imageFile" class="btn-file-upload">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-paperclip" viewBox="0 0 16 16">
                                  <path d="M4.5 3a2.5 2.5 0 0 1 5 0v9a1.5 1.5 0 0 1-3 0V5a.5.5 0 0 1 1 0v7a.5.5 0 0 0 1 0V3a1.5 1.5 0 1 0-3 0v9a2.5 2.5 0 0 0 5 0V5a.5.5 0 0 1 1 0v7a3.5 3.5 0 1 1-7 0z"/>
                                </svg>
                                เลือกไฟล์รูปภาพ
                            </label>
                            <input type="file" id="imageFile" accept="image/*">
                        </div>
                        <small id="imageFileName" class="form-text text-muted mt-2"></small>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitButton">ส่งงาน</button>
                    </div>
                </form>

                <div id="loading" class="text-center mt-3">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">กำลังส่งข้อมูล...</p>
                </div>
                
                <div id="successMessage" class="alert alert-success text-center mt-3">
                    <h4>✅ ส่งงานสำเร็จ!</h4>
                    <p>ระบบจะปิดหน้าต่างนี้อัตโนมัติ</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // ------ ⚠️ กรุณาแก้ไข LIFF ID ของคุณ ⚠️ ------
        const LIFF_ID = "2007619494-5DqrWAPG"; // <--- ใส่ LIFF ID ของคุณที่นี่
        
        // ------ ⚠️ กรุณาใส่ GAS Web App URL ของคุณ ⚠️ ------
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyzY6dgt6-ZBJn5duuuXKErc5Odep4XrlZmFuFdPNsI6Cl8CFBZt-duTDR-7XwnRU_w/exec"; // <--- ใส่ URL ของคุณที่นี่

        // --- JavaScript ที่ปรับปรุงให้ง่ายขึ้น ---

        let selectedFile = null;

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                }
            } catch (err) {
                console.error("LIFF Initialization failed", err);
                alert("ไม่สามารถเริ่มต้น LIFF ได้ โปรดลองอีกครั้งในแอป LINE");
            }
        }
        main();

        // Listener สำหรับจัดการการเลือกไฟล์
        document.getElementById('imageFile').addEventListener('change', function(e) {
            if (e.target.files && e.target.files.length > 0) {
                selectedFile = e.target.files[0];
                document.getElementById('imageFileName').innerText = `ไฟล์ที่เลือก: ${selectedFile.name}`;
            } else {
                selectedFile = null;
                document.getElementById('imageFileName').innerText = '';
            }
        });
        
        // --- ลบ Listener ของปุ่มถ่ายรูปออกทั้งหมด ---

        document.getElementById('submissionForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const studentId = document.getElementById('studentId').value;
            const assignment = document.getElementById('assignment').value;
            
            if (!studentId || !assignment || !selectedFile) {
                alert("กรุณากรอกข้อมูลให้ครบทุกช่อง และแนบรูปภาพงาน");
                return;
            }

            document.getElementById('submissionForm').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            const reader = new FileReader();
            reader.readAsDataURL(selectedFile);

            reader.onload = async () => {
                const payload = {
                    studentId: studentId,
                    assignment: assignment,
                    fileName: selectedFile.name,
                    fileData: reader.result
                };

                try {
                    const response = await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        redirect: 'follow',
                        body: JSON.stringify(payload),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                    });

                    const result = await response.json();
                    
                    document.getElementById('loading').style.display = 'none';
                    if (result.status === 'success') {
                        document.getElementById('successMessage').style.display = 'block';
                        setTimeout(() => {
                            if (liff.isInClient()) {
                                liff.closeWindow();
                            }
                        }, 2500);
                    } else {
                        throw new Error(result.message || 'Unknown error from server');
                    }
                } catch (error) {
                    document.getElementById('loading').style.display = 'none';
                    alert('เกิดข้อผิดพลาดในการส่งข้อมูล: ' + error.message);
                    document.getElementById('submissionForm').style.display = 'block';
                }
            };

            reader.onerror = (error) => {
                console.error("FileReader error:", error);
                alert('เกิดข้อผิดพลาดในการอ่านไฟล์! กรุณาลองเลือกไฟล์ใหม่อีกครั้ง');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('submissionForm').style.display = 'block';
            };
        });
    </script>
</body>
</html>
